name: Build iOS IPA

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: Install CocoaPods
      run: bundle install

    - name: Install dependencies
      run: npm install

    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install
        cd ..

    - name: Import signing certificate
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_CERT_P12 }}
        p12-password: ${{ secrets.IOS_CERT_PASSWORD }}

    - name: Install provisioning profile
      id: install_profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision
        
        # Extract UUID and other info from provisioning profile
        PROFILE_UUID=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision 2>/dev/null | plutil -extract UUID raw -)
        PROFILE_NAME=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision 2>/dev/null | plutil -extract Name raw -)
        PROFILE_BUNDLE_ID=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision 2>/dev/null | plutil -extract Entitlements.application-identifier raw - | sed 's/.*\.//')
        
        if [ -n "$PROFILE_UUID" ]; then
          echo "Provisioning profile UUID: $PROFILE_UUID"
          echo "Provisioning profile Name: $PROFILE_NAME"
          echo "Provisioning profile Bundle ID: $PROFILE_BUNDLE_ID"
          echo "profile_uuid=$PROFILE_UUID" >> $GITHUB_OUTPUT
          echo "profile_name=$PROFILE_NAME" >> $GITHUB_OUTPUT
          # Also install with UUID as filename (required by xcodebuild)
          cp ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
        else
          echo "Error: Could not extract UUID from provisioning profile"
          exit 1
        fi

    - name: Create export options plist
      run: |
        cat > ios/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.gemiso.sbsnds.dev</key>
                <string>SBS NDS</string>
            </dict>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>none</string>
        </dict>
        </plist>
        EOF

    - name: Verify certificates and profiles
      id: verify_certs
      run: |
        set -e
        echo "=== Checking installed certificates ==="
        ALL_CERTS=$(security find-identity -v -p codesigning)
        echo "$ALL_CERTS"
        DIST_CERTS=$(echo "$ALL_CERTS" | grep "Apple Distribution" || echo "")
        if [ -z "$DIST_CERTS" ]; then
          echo "ERROR: No Apple Distribution certificate found in keychain"
          exit 1
        fi

        echo ""
        echo "=== Checking provisioning profile ==="
        PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision
        if [ ! -f "$PROFILE_PATH" ]; then
          echo "ERROR: Provisioning profile not found at $PROFILE_PATH"
          exit 1
        fi

        echo ""
        echo "=== Decoding provisioning profile ==="
        PROFILE_XML=$(security cms -D -i "$PROFILE_PATH" 2>/dev/null | plutil -convert xml1 -o - - 2>/dev/null)
        if [ -z "$PROFILE_XML" ]; then
          echo "ERROR: Could not decode provisioning profile"
          exit 1
        fi

        echo "Extracting embedded certificates..."
        CERT_BASE64_LIST=$(echo "$PROFILE_XML" | awk '/<key>DeveloperCertificates<\/key>/,/<\/array>/' | grep '<data>' | sed 's/ *<[^>]*>//g' | tr -d ' ')
        if [ -z "$CERT_BASE64_LIST" ]; then
          echo "ERROR: No DeveloperCertificates found in provisioning profile"
          exit 1
        fi

        PROFILE_CERT_COUNT=0
        PROFILE_CERT_CNs=""
        PROFILE_CERT_SHA1s=""

        while IFS= read -r CERT_DATA; do
          [ -z "$CERT_DATA" ] && continue
          PROFILE_CERT_COUNT=$((PROFILE_CERT_COUNT+1))
          CERT_SUBJECT=$(echo "$CERT_DATA" | base64 -d 2>/dev/null | openssl x509 -noout -subject 2>/dev/null | sed 's/subject=//')
          CERT_CN=$(echo "$CERT_DATA" | base64 -d 2>/dev/null | openssl x509 -noout -subject 2>/dev/null | sed -E 's/.*CN *= *([^,]+).*/\1/')
          CERT_SHA1=$(echo "$CERT_DATA" | base64 -d 2>/dev/null | openssl x509 -noout -fingerprint -sha1 2>/dev/null | sed 's/SHA1 Fingerprint=//' | tr -d ':' | tr '[:upper:]' '[:lower:]')
          echo "  [$PROFILE_CERT_COUNT] CN: $CERT_CN"
          echo "      SHA1: $CERT_SHA1"
          if [ -n "$PROFILE_CERT_CNs" ]; then
            PROFILE_CERT_CNs="$PROFILE_CERT_CNs|$CERT_CN"
            PROFILE_CERT_SHA1s="$PROFILE_CERT_SHA1s|$CERT_SHA1"
          else
            PROFILE_CERT_CNs="$CERT_CN"
            PROFILE_CERT_SHA1s="$CERT_SHA1"
          fi
        done <<< "$CERT_BASE64_LIST"

        if [ $PROFILE_CERT_COUNT -eq 0 ]; then
          echo "ERROR: No certificates parsed from provisioning profile"
          exit 1
        fi

        echo ""
        echo "=== Checking keychain for matching distribution certificate ==="
        MATCH_FOUND=false
        while IFS= read -r line; do
          CERT_NAME=$(echo "$line" | sed -E 's/.*"([^"]+)".*/\1/')
          CERT_PEM=$(security find-certificate -c "$CERT_NAME" -p 2>/dev/null || echo "")
          CERT_SHA1=$(echo "$CERT_PEM" | openssl x509 -noout -fingerprint -sha1 2>/dev/null | sed 's/SHA1 Fingerprint=//' | tr -d ':' | tr '[:upper:]' '[:lower:]')
          echo "Keychain: $CERT_NAME ($CERT_SHA1)"
          for PROFILE_SHA1 in $(echo "$PROFILE_CERT_SHA1s" | tr '|' ' '); do
            if [ "$CERT_SHA1" = "$PROFILE_SHA1" ]; then
              echo "✅ Match found for $CERT_NAME"
              MATCH_FOUND=true
              break
            fi
          done
        done <<< "$DIST_CERTS"

        echo ""
        echo "=== Verification Result ==="
        if [ "$MATCH_FOUND" = true ]; then
          echo "✅ SUCCESS: Found matching certificate in keychain and provisioning profile"
        else
          echo "❌ ERROR: No matching certificate found between keychain and provisioning profile"
          echo ""
          echo "Fix:"
          echo "  - Recreate provisioning profile in Apple Developer Portal including the same certificate as in your P12"
          exit 1
        fi

    - name: Build and Archive
      env:
        DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
      run: |
        set -e
        cd ios
        echo "Cleaning workspace..."
        xcodebuild clean \
          -workspace webEditApp.xcworkspace \
          -scheme webEditApp \
          -configuration Release

        echo "Building and archiving..."
        echo "Using provisioning profile UUID: ${{ steps.install_profile.outputs.profile_uuid }}"
        # Try with specific certificate first, if fails, let xcodebuild auto-select
        xcodebuild archive \
          -workspace webEditApp.xcworkspace \
          -scheme webEditApp \
          -configuration Release \
          -archivePath build/webEditApp.xcarchive \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="${{ steps.install_profile.outputs.profile_uuid }}" \
          DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }} \
          ENABLE_BITCODE=NO || {
            echo "Build failed with specific certificate, trying auto-select..."
            # Remove CODE_SIGN_IDENTITY to let xcodebuild auto-select matching certificate
            xcodebuild archive \
              -workspace webEditApp.xcworkspace \
              -scheme webEditApp \
              -configuration Release \
              -archivePath build/webEditApp.xcarchive \
              -destination 'generic/platform=iOS' \
              CODE_SIGN_STYLE=Manual \
              PROVISIONING_PROFILE_SPECIFIER="${{ steps.install_profile.outputs.profile_uuid }}" \
              DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }} \
              ENABLE_BITCODE=NO
          }

        echo "Archive created successfully at: build/webEditApp.xcarchive"

    - name: Export IPA
      env:
        DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
      run: |
        set -e
        cd ios
        xcodebuild -exportArchive \
          -archivePath build/webEditApp.xcarchive \
          -exportPath build/export \
          -exportOptionsPlist ExportOptions.plist

    - name: Verify IPA
      run: |
        ls -lh ios/build/export/*.ipa || echo "No IPA file found"
        cd ios/build/export
        if compgen -G "*.ipa" > /dev/null; then
          unzip -l *.ipa | head -20
        else
          echo "No IPA found"
        fi

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: webEditApp-ios
        path: ios/build/export/*.ipa
        retention-days: 7

    - name: Clean up
      if: always()
      run: |
        rm -rf ios/build
        rm -f ios/ExportOptions.plist