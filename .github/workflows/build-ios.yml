name: Build iOS IPA

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: Install CocoaPods
      run: bundle install

    - name: Install dependencies
      run: npm install

    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install
        cd ..

    - name: Import signing certificate
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_CERT_P12 }}
        p12-password: ${{ secrets.IOS_CERT_PASSWORD }}

    - name: Install provisioning profile
      id: install_profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision
        
        # Extract UUID and other info from provisioning profile
        PROFILE_UUID=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision 2>/dev/null | plutil -extract UUID raw -)
        PROFILE_NAME=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision 2>/dev/null | plutil -extract Name raw -)
        PROFILE_BUNDLE_ID=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision 2>/dev/null | plutil -extract Entitlements.application-identifier raw - | sed 's/.*\.//')
        
        if [ -n "$PROFILE_UUID" ]; then
          echo "Provisioning profile UUID: $PROFILE_UUID"
          echo "Provisioning profile Name: $PROFILE_NAME"
          echo "Provisioning profile Bundle ID: $PROFILE_BUNDLE_ID"
          echo "profile_uuid=$PROFILE_UUID" >> $GITHUB_OUTPUT
          echo "profile_name=$PROFILE_NAME" >> $GITHUB_OUTPUT
          # Also install with UUID as filename (required by xcodebuild)
          cp ~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
        else
          echo "Error: Could not extract UUID from provisioning profile"
          exit 1
        fi

    - name: Create export options plist
      run: |
        cat > ios/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.gemiso.sbsnds.dev</key>
                <string>SBS NDS</string>
            </dict>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>none</string>
        </dict>
        </plist>
        EOF

    - name: Verify certificates and profiles
      id: verify_certs
      run: |
        set -e
        echo "=== Checking installed certificates ==="
        ALL_CERTS=$(security find-identity -v -p codesigning)
        echo "$ALL_CERTS"
        DIST_CERTS=$(echo "$ALL_CERTS" | grep "Apple Distribution" || echo "")
        if [ -z "$DIST_CERTS" ]; then
          echo "ERROR: No Apple Distribution certificate found in keychain"
          exit 1
        fi
        echo ""
        echo "=== Checking provisioning profiles ==="
        PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/vDuc.mobileprovision
        if [ ! -f "$PROFILE_PATH" ]; then
          echo "ERROR: Provisioning profile not found at $PROFILE_PATH"
          exit 1
        fi
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ || echo "No profiles directory found"
        echo ""
        echo "=== Verifying certificate and profile match ==="
        # Extract certificate from provisioning profile
        PROFILE_PLIST=$(security cms -D -i "$PROFILE_PATH" 2>/dev/null)
        if [ -z "$PROFILE_PLIST" ]; then
          echo "ERROR: Could not decode provisioning profile"
          exit 1
        fi
        
        # Extract all certificates from provisioning profile
        echo "Extracting certificates from provisioning profile..."
        PROFILE_CERT_COUNT=0
        PROFILE_CERT_CNs=""
        PROFILE_CERT_SHA1s=""
        
        # Determine certificate count robustly from XML
        CERT_COUNT=$(echo "$PROFILE_PLIST" | plutil -convert xml1 -o - - 2>/dev/null | grep -o "<data>" | wc -l | tr -d ' ' || echo "0")
        # Fallback to zero if not a valid integer
        if ! echo "$CERT_COUNT" | grep -Eq '^[0-9]+$'; then
          CERT_COUNT=0
        fi
        echo "Found $CERT_COUNT certificate(s) in provisioning profile"

        # Iterate through each certificate by index (bounded to avoid infinite loops)
        for (( i=0; i<CERT_COUNT; i++ )); do
          CERT_DATA=$(echo "$PROFILE_PLIST" | plutil -extract "DeveloperCertificates.$i" raw - 2>/dev/null || echo "")
          if [ -z "$CERT_DATA" ]; then
            continue
          fi
          
          # Extract certificate info (normalize SHA1: lowercase, no colons)
          CERT_SUBJECT=$(echo "$CERT_DATA" | base64 -d 2>/dev/null | openssl x509 -noout -subject 2>/dev/null | sed 's/subject=//' || echo "")
          CERT_CN=$(echo "$CERT_DATA" | base64 -d 2>/dev/null | openssl x509 -noout -subject 2>/dev/null | sed -E 's/.*CN *= *([^,]+).*/\1/' || echo "")
          CERT_SHA1=$(echo "$CERT_DATA" | base64 -d 2>/dev/null | openssl x509 -noout -fingerprint -sha1 2>/dev/null | sed 's/SHA1 Fingerprint=//' | tr -d ':' | tr '[:upper:]' '[:lower:]' || echo "")
          
          if [ -n "$CERT_SUBJECT" ]; then
            PROFILE_CERT_COUNT=$((PROFILE_CERT_COUNT + 1))
            echo "  Certificate $PROFILE_CERT_COUNT:"
            echo "    Subject: $CERT_SUBJECT"
            echo "    CN: $CERT_CN"
            echo "    SHA1: $CERT_SHA1"
            
            if [ -n "$PROFILE_CERT_CNs" ]; then
              PROFILE_CERT_CNs="$PROFILE_CERT_CNs|$CERT_CN"
              PROFILE_CERT_SHA1s="$PROFILE_CERT_SHA1s|$CERT_SHA1"
            else
              PROFILE_CERT_CNs="$CERT_CN"
              PROFILE_CERT_SHA1s="$CERT_SHA1"
            fi
          fi
          
        done
        
        if [ $PROFILE_CERT_COUNT -eq 0 ]; then
          echo "ERROR: No certificates found in provisioning profile"
          exit 1
        fi
        
        echo ""
        echo "=== Checking keychain certificates ==="
        # Extract certificates from keychain and compare
        KEYCHAIN_CERT_COUNT=0
        MATCH_FOUND=false
        
        # Process each certificate line (avoid subshell issue)
        IFS=$'\n'
        for line in $DIST_CERTS; do
          if echo "$line" | grep -q "Apple Distribution"; then
            KEYCHAIN_CERT_COUNT=$((KEYCHAIN_CERT_COUNT + 1))
            
            # Extract certificate hash and name more reliably
            CERT_HASH=$(echo "$line" | sed -E 's/.*\) ([A-F0-9]+).*/\1/' | head -c 40 || echo "")
            CERT_NAME=$(echo "$line" | sed -E 's/.*"([^"]+Apple Distribution[^"]+)".*/\1/' || echo "")
            
            # Fallback: extract name without quotes
            if [ -z "$CERT_NAME" ] || [ "$CERT_NAME" = "$line" ]; then
              CERT_NAME=$(echo "$line" | sed -E 's/.*Apple Distribution:? *([^(]+).*/\1/' | sed 's/ *$//' || echo "Unknown")
            fi
            
            echo "  Keychain Certificate $KEYCHAIN_CERT_COUNT:"
            echo "    Name: $CERT_NAME"
            echo "    Hash: $CERT_HASH"
            
            # Get certificate PEM data and extract SHA1
            CERT_PEM=$(security find-certificate -c "$CERT_NAME" -p 2>/dev/null || echo "")
            
            if [ -n "$CERT_PEM" ]; then
              CERT_SUBJECT=$(echo "$CERT_PEM" | openssl x509 -noout -subject 2>/dev/null | sed 's/subject=//' || echo "")
              CERT_CN=$(echo "$CERT_PEM" | openssl x509 -noout -subject 2>/dev/null | sed -E 's/.*CN *= *([^,]+).*/\1/' || echo "")
              CERT_SHA1=$(echo "$CERT_PEM" | openssl x509 -noout -fingerprint -sha1 2>/dev/null | sed 's/SHA1 Fingerprint=//' | tr -d ':' | tr '[:upper:]' '[:lower:]' || echo "")
              
              echo "    Subject: $CERT_SUBJECT"
              echo "    CN: $CERT_CN"
              echo "    SHA1: $CERT_SHA1"
              
              # Compare SHA1 fingerprints (normalize to lowercase, no colons)
              if [ -n "$CERT_SHA1" ] && [ -n "$PROFILE_CERT_SHA1s" ]; then
                # Convert profile SHA1s to same format for comparison
                PROFILE_SHA1s_NORMALIZED=$(echo "$PROFILE_CERT_SHA1s" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
                
                # Check if certificate SHA1 matches any profile SHA1
                for profile_sha1 in $(echo "$PROFILE_SHA1s_NORMALIZED" | tr '|' ' '); do
                  if [ "$CERT_SHA1" = "$profile_sha1" ]; then
                    echo "    ✅ MATCH FOUND: Certificate SHA1 matches provisioning profile"
                    MATCH_FOUND=true
                    break
                  fi
                done
                
                if [ "$MATCH_FOUND" != "true" ]; then
                  echo "    ❌ NO MATCH: Certificate SHA1 does NOT match any in provisioning profile"
                fi
              elif [ -n "$CERT_CN" ] && [ -n "$PROFILE_CERT_CNs" ]; then
                # Fallback: compare by CN if SHA1 comparison fails
                if echo "$PROFILE_CERT_CNs" | grep -q "$CERT_CN"; then
                  echo "    ✅ MATCH FOUND: Certificate CN matches provisioning profile"
                  MATCH_FOUND=true
                else
                  echo "    ❌ NO MATCH: Certificate CN does NOT match any in provisioning profile"
                fi
              else
                echo "    ⚠️ WARNING: Could not compare certificates (missing SHA1 or CN)"
              fi
            else
              echo "    ⚠️ WARNING: Could not extract certificate from keychain"
            fi
            echo ""
          fi
        done
        unset IFS
        
        if [ $KEYCHAIN_CERT_COUNT -eq 0 ]; then
          echo "ERROR: No Apple Distribution certificates found in keychain"
          exit 1
        fi
        
        echo "=== Verification Result ==="
        if [ "$MATCH_FOUND" = true ]; then
          echo "✅ SUCCESS: Found matching certificate in keychain and provisioning profile"
        else
          echo "❌ ERROR: No matching certificate found between keychain and provisioning profile"
          echo ""
          echo "Certificate mismatch detected!"
          echo "The certificate in your keychain does not match any certificate in the provisioning profile."
          echo ""
          echo "To fix this issue:"
          echo "1. Go to Apple Developer Portal: https://developer.apple.com/account/resources/profiles/list"
          echo "2. Create a new Ad Hoc provisioning profile that includes the certificate currently in keychain"
          echo "3. Download the new provisioning profile"
          echo "4. Encode it to base64: base64 -i profile.mobileprovision | pbcopy"
          echo "5. Update the IOS_PROVISIONING_PROFILE secret in GitHub with the new base64-encoded profile"
          echo ""
          echo "Alternatively:"
          echo "1. Export the certificate from the provisioning profile"
          echo "2. Import it into your keychain"
          echo "3. Update the IOS_CERT_P12 secret with the new certificate"
          exit 1
        fi

    - name: Build and Archive
      env:
        DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
      run: |
        set -e
        cd ios
        echo "Cleaning workspace..."
        xcodebuild clean \
          -workspace webEditApp.xcworkspace \
          -scheme webEditApp \
          -configuration Release

        echo "Building and archiving..."
        echo "Using provisioning profile UUID: ${{ steps.install_profile.outputs.profile_uuid }}"
        # Try with specific certificate first, if fails, let xcodebuild auto-select
        xcodebuild archive \
          -workspace webEditApp.xcworkspace \
          -scheme webEditApp \
          -configuration Release \
          -archivePath build/webEditApp.xcarchive \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="${{ steps.install_profile.outputs.profile_uuid }}" \
          DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }} \
          ENABLE_BITCODE=NO || {
            echo "Build failed with specific certificate, trying auto-select..."
            # Remove CODE_SIGN_IDENTITY to let xcodebuild auto-select matching certificate
            xcodebuild archive \
              -workspace webEditApp.xcworkspace \
              -scheme webEditApp \
              -configuration Release \
              -archivePath build/webEditApp.xcarchive \
              -destination 'generic/platform=iOS' \
              CODE_SIGN_STYLE=Manual \
              PROVISIONING_PROFILE_SPECIFIER="${{ steps.install_profile.outputs.profile_uuid }}" \
              DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }} \
              ENABLE_BITCODE=NO
          }

        echo "Archive created successfully at: build/webEditApp.xcarchive"

    - name: Export IPA
      env:
        DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
      run: |
        set -e
        cd ios
        xcodebuild -exportArchive \
          -archivePath build/webEditApp.xcarchive \
          -exportPath build/export \
          -exportOptionsPlist ExportOptions.plist

    - name: Verify IPA
      run: |
        ls -lh ios/build/export/*.ipa || echo "No IPA file found"
        cd ios/build/export
        if compgen -G "*.ipa" > /dev/null; then
          unzip -l *.ipa | head -20
        else
          echo "No IPA found"
        fi

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: webEditApp-ios
        path: ios/build/export/*.ipa
        retention-days: 7

    - name: Clean up
      if: always()
      run: |
        rm -rf ios/build
        rm -f ios/ExportOptions.plist